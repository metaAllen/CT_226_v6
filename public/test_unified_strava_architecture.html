<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±ä¸€ Strava æ¶æ§‹æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-healthy { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }
        .status-unknown { background: #6c757d; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ çµ±ä¸€ Strava æ¶æ§‹æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹ç›£æ§</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="syncStatus">-</div>
                <div class="metric-label">åŒæ­¥ç‹€æ…‹</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="tokenStatus">-</div>
                <div class="metric-label">Token ç‹€æ…‹</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="errorCount">-</div>
                <div class="metric-label">éŒ¯èª¤è¨ˆæ•¸</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="lastSync">-</div>
                <div class="metric-label">æœ€å¾ŒåŒæ­¥</div>
            </div>
        </div>
        <button class="test-button" onclick="updateSystemStatus()">æ›´æ–°ç‹€æ…‹</button>
        <div id="statusResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ çµ±ä¸€ç®¡ç†å™¨æ¸¬è©¦</h2>
        <p>æ¸¬è©¦çµ±ä¸€ Strava åŒæ­¥ç®¡ç†å™¨çš„åŸºæœ¬åŠŸèƒ½</p>
        <button class="test-button" onclick="testUnifiedManager()">æ¸¬è©¦ç®¡ç†å™¨è¼‰å…¥</button>
        <button class="test-button" onclick="testManagerState()">æª¢æŸ¥ç®¡ç†å™¨ç‹€æ…‹</button>
        <button class="test-button" onclick="testObserverPattern()">æ¸¬è©¦è§€å¯Ÿè€…æ¨¡å¼</button>
        <div id="managerResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ åŒæ­¥åŠŸèƒ½æ¸¬è©¦</h2>
        <p>æ¸¬è©¦ Strava åŒæ­¥çš„å„é …åŠŸèƒ½</p>
        <button class="test-button" onclick="testTokenCheck()">æª¢æŸ¥ Token</button>
        <button class="test-button" onclick="testTokenRefresh()">åˆ·æ–° Token</button>
        <button class="test-button" onclick="testForceSync()">å¼·åˆ¶åŒæ­¥</button>
        <button class="test-button" onclick="testEnableSync()">å•Ÿç”¨åŒæ­¥</button>
        <button class="test-button" onclick="testDisableSync()">ç¦ç”¨åŒæ­¥</button>
        <div id="syncResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ å¾Œç«¯ API æ¸¬è©¦</h2>
        <p>æ¸¬è©¦æ”¹é€²çš„å¾Œç«¯ API ç«¯é»</p>
        <button class="test-button" onclick="testHealthAPI()">å¥åº·æª¢æŸ¥ API</button>
        <button class="test-button" onclick="testStatusAPI()">ç‹€æ…‹ç®¡ç† API</button>
        <button class="test-button" onclick="testSmartMerge()">æ™ºæ…§åˆä½µæ¸¬è©¦</button>
        <div id="apiResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ˆ æ€§èƒ½æ¸¬è©¦</h2>
        <p>æ¸¬è©¦æ–°æ¶æ§‹çš„æ€§èƒ½è¡¨ç¾</p>
        <button class="test-button" onclick="testPerformance()">æ€§èƒ½æ¸¬è©¦</button>
        <button class="test-button" onclick="testMemoryUsage()">å…§å­˜ä½¿ç”¨æ¸¬è©¦</button>
        <button class="test-button" onclick="testRequestDeduplication()">è«‹æ±‚å»é‡æ¸¬è©¦</button>
        <div id="performanceResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª æ•´åˆæ¸¬è©¦</h2>
        <p>æ¸¬è©¦å®Œæ•´çš„å·¥ä½œæµç¨‹</p>
        <button class="test-button" onclick="runFullIntegrationTest()">å®Œæ•´æ•´åˆæ¸¬è©¦</button>
        <button class="test-button" onclick="testErrorHandling()">éŒ¯èª¤è™•ç†æ¸¬è©¦</button>
        <button class="test-button" onclick="testDataConsistency()">æ•¸æ“šä¸€è‡´æ€§æ¸¬è©¦</button>
        <div id="integrationResult" class="result"></div>
    </div>

    <!-- å¼•å…¥çµ±ä¸€ç®¡ç†å™¨ -->
    <script src="strava_sync_unified.js"></script>
    
    <script>
        // å…¨å±€è®Šé‡
        let testResults = {};
        let performanceMetrics = {};
        
        // ===== ç³»çµ±ç‹€æ…‹ç›£æ§ =====
        function updateSystemStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ›´æ–°ç³»çµ±ç‹€æ…‹...';
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    resultDiv.className = 'result error';
                    return;
                }
                
                const stats = unified.getStats();
                const state = unified.getState();
                
                // æ›´æ–°æŒ‡æ¨™å¡ç‰‡
                document.getElementById('syncStatus').textContent = state.syncEnabled ? 'å•Ÿç”¨' : 'ç¦ç”¨';
                document.getElementById('tokenStatus').textContent = state.tokenValid ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ';
                document.getElementById('errorCount').textContent = state.errorCount;
                document.getElementById('lastSync').textContent = state.lastSyncTime ? 
                    new Date(state.lastSyncTime).toLocaleTimeString() : 'å¾æœª';
                
                const statusText = `ğŸ“Š ç³»çµ±ç‹€æ…‹å ±å‘Š
                
ğŸ”„ åŒæ­¥ç‹€æ…‹: ${state.syncEnabled ? 'âœ… å•Ÿç”¨' : 'âŒ ç¦ç”¨'}
ğŸ”‘ Token ç‹€æ…‹: ${state.tokenValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ ç„¡æ•ˆ'}
âš ï¸ éŒ¯èª¤è¨ˆæ•¸: ${state.errorCount}
ğŸ“… æœ€å¾ŒåŒæ­¥: ${state.lastSyncTime ? new Date(state.lastSyncTime).toLocaleString() : 'å¾æœª'}
â±ï¸ åŒæ­¥é€²è¡Œä¸­: ${state.syncInProgress ? 'æ˜¯' : 'å¦'}

ğŸ“ˆ æ€§èƒ½æŒ‡æ¨™:
- æ´»èºå®šæ™‚å™¨: ${stats.activeTimers}
- ç·©å­˜è«‹æ±‚: ${stats.cachedRequests}
- åŒæ­¥å•Ÿç”¨: ${stats.syncEnabled}
- Token æœ‰æ•ˆ: ${stats.tokenValid}`;
                
                resultDiv.innerHTML = statusText;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ›´æ–°ç‹€æ…‹å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        // ===== çµ±ä¸€ç®¡ç†å™¨æ¸¬è©¦ =====
        function testUnifiedManager() {
            const resultDiv = document.getElementById('managerResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦çµ±ä¸€ç®¡ç†å™¨...';
            
            try {
                const unified = window.stravaSyncManager;
                
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    resultDiv.className = 'result error';
                    return;
                }
                
                // æ¸¬è©¦åŸºæœ¬æ–¹æ³•
                const state = unified.getState();
                const stats = unified.getStats();
                
                const testResults = {
                    'ç®¡ç†å™¨è¼‰å…¥': 'âœ… æˆåŠŸ',
                    'getState()': typeof unified.getState === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨',
                    'getStats()': typeof unified.getStats === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨',
                    'addObserver()': typeof unified.addObserver === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨',
                    'enableSync()': typeof unified.enableSync === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨',
                    'disableSync()': typeof unified.disableSync === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨',
                    'forceSync()': typeof unified.forceSync === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'
                };
                
                let resultText = 'ğŸ§ª çµ±ä¸€ç®¡ç†å™¨æ¸¬è©¦çµæœ:\n\n';
                Object.entries(testResults).forEach(([test, result]) => {
                    resultText += `${test}: ${result}\n`;
                });
                
                resultText += `\nğŸ“Š ç•¶å‰ç‹€æ…‹:\n${JSON.stringify(state, null, 2)}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        function testManagerState() {
            const resultDiv = document.getElementById('managerResult');
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                const state = unified.getState();
                const stats = unified.getStats();
                
                const stateText = `ğŸ” ç®¡ç†å™¨ç‹€æ…‹è©³æƒ…:

ğŸ“‹ åŸºæœ¬ç‹€æ…‹:
- åŒæ­¥å•Ÿç”¨: ${state.syncEnabled}
- Token æœ‰æ•ˆ: ${state.tokenValid}
- åŒæ­¥é€²è¡Œä¸­: ${state.syncInProgress}
- éŒ¯èª¤è¨ˆæ•¸: ${state.errorCount}
- æœ€å¾ŒåŒæ­¥: ${state.lastSyncTime || 'å¾æœª'}

ğŸ“Š æ€§èƒ½çµ±è¨ˆ:
- æ´»èºå®šæ™‚å™¨: ${stats.activeTimers}
- ç·©å­˜è«‹æ±‚: ${stats.cachedRequests}
- åŒæ­¥å•Ÿç”¨: ${stats.syncEnabled}
- Token æœ‰æ•ˆ: ${stats.tokenValid}
- æœ€å¾ŒåŒæ­¥: ${stats.lastSyncTime}
- éŒ¯èª¤è¨ˆæ•¸: ${stats.errorCount}`;
                
                resultDiv.innerHTML = stateText;
                resultDiv.className = 'result info';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        function testObserverPattern() {
            const resultDiv = document.getElementById('managerResult');
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                let observerTestResults = [];
                
                // æ·»åŠ æ¸¬è©¦è§€å¯Ÿè€…
                const testObserver = (event, data) => {
                    observerTestResults.push({ event, data, timestamp: new Date().toISOString() });
                };
                
                unified.addObserver(testObserver);
                
                // è§¸ç™¼ä¸€äº›äº‹ä»¶ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                setTimeout(() => {
                    unified.removeObserver(testObserver);
                    
                    const resultText = `ğŸ‘ï¸ è§€å¯Ÿè€…æ¨¡å¼æ¸¬è©¦çµæœ:

ğŸ“ æ¸¬è©¦è§€å¯Ÿè€…å·²æ·»åŠ å’Œç§»é™¤: âœ… æˆåŠŸ
ğŸ“Š è§€å¯Ÿåˆ°çš„äº‹ä»¶æ•¸é‡: ${observerTestResults.length}

${observerTestResults.length > 0 ? 
    'ğŸ“‹ è§€å¯Ÿåˆ°çš„äº‹ä»¶:\n' + observerTestResults.map(r => 
        `- ${r.event} (${r.timestamp})`
    ).join('\n') : 
    'â„¹ï¸ æš«ç„¡äº‹ä»¶è§¸ç™¼ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼Œå› ç‚ºæ²’æœ‰å¯¦éš›çš„åŒæ­¥æ“ä½œï¼‰'}`;
                    
                    resultDiv.innerHTML = resultText;
                    resultDiv.className = 'result success';
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ è§€å¯Ÿè€…æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        // ===== åŒæ­¥åŠŸèƒ½æ¸¬è©¦ =====
        async function testTokenCheck() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = 'æ­£åœ¨æª¢æŸ¥ Token...';
            
            try {
                const response = await fetch('/api/strava/check-token', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                const data = await response.json();
                
                const resultText = `ğŸ”‘ Token æª¢æŸ¥çµæœ:

ç‹€æ…‹ç¢¼: ${response.status}
Token æœ‰æ•ˆ: ${data.valid ? 'âœ… æ˜¯' : 'âŒ å¦'}
éæœŸæ™‚é–“: ${data.expiresAt || 'æœªçŸ¥'}
éŒ¯èª¤ä¿¡æ¯: ${data.error || 'ç„¡'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = response.ok ? 'result success' : 'result error';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ Token æª¢æŸ¥å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testTokenRefresh() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = 'æ­£åœ¨åˆ·æ–° Token...';
            
            try {
                const response = await fetch('/api/strava/refresh-token', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                const data = await response.json();
                
                const resultText = `ğŸ”„ Token åˆ·æ–°çµæœ:

ç‹€æ…‹ç¢¼: ${response.status}
åˆ·æ–°æˆåŠŸ: ${data.success ? 'âœ… æ˜¯' : 'âŒ å¦'}
æ–°éæœŸæ™‚é–“: ${data.expiresAt || 'æœªçŸ¥'}
éŒ¯èª¤ä¿¡æ¯: ${data.error || 'ç„¡'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = response.ok ? 'result success' : 'result error';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ Token åˆ·æ–°å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testForceSync() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = 'æ­£åœ¨å¼·åˆ¶åŒæ­¥...';
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                await unified.forceSync();
                
                resultDiv.innerHTML = 'âœ… å¼·åˆ¶åŒæ­¥å·²è§¸ç™¼';
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ å¼·åˆ¶åŒæ­¥å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testEnableSync() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = 'æ­£åœ¨å•Ÿç”¨åŒæ­¥...';
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                await unified.enableSync();
                
                resultDiv.innerHTML = 'âœ… åŒæ­¥å·²å•Ÿç”¨';
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ å•Ÿç”¨åŒæ­¥å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testDisableSync() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = 'æ­£åœ¨ç¦ç”¨åŒæ­¥...';
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                await unified.disableSync();
                
                resultDiv.innerHTML = 'âœ… åŒæ­¥å·²ç¦ç”¨';
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ ç¦ç”¨åŒæ­¥å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        // ===== å¾Œç«¯ API æ¸¬è©¦ =====
        async function testHealthAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦å¥åº·æª¢æŸ¥ API...';
            
            try {
                const response = await fetch('/api/strava/health', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                const data = await response.json();
                
                const resultText = `ğŸ¥ å¥åº·æª¢æŸ¥çµæœ:

ç‹€æ…‹ç¢¼: ${response.status}
ç³»çµ±ç‹€æ…‹: ${data.status}
åŒæ­¥å•Ÿç”¨: ${data.stravaSyncEnabled ? 'âœ… æ˜¯' : 'âŒ å¦'}
æœ‰ Access Token: ${data.hasAccessToken ? 'âœ… æ˜¯' : 'âŒ å¦'}
æœ‰ Refresh Token: ${data.hasRefreshToken ? 'âœ… æ˜¯' : 'âŒ å¦'}
Token éæœŸæ™‚é–“: ${data.tokenExpiresAt || 'æœªçŸ¥'}
æœ€å¾ŒåŒæ­¥: ${data.lastSync || 'å¾æœª'}
æœ€å¾Œ Token åˆ·æ–°: ${data.lastTokenRefresh || 'å¾æœª'}
éŒ¯èª¤ä¿¡æ¯: ${data.error || 'ç„¡'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = response.ok ? 'result success' : 'result error';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ å¥åº·æª¢æŸ¥å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testStatusAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦ç‹€æ…‹ç®¡ç† API...';
            
            try {
                // æ¸¬è©¦ç²å–ç•¶å‰ç‹€æ…‹
                const healthResponse = await fetch('/api/strava/health', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                const healthData = await healthResponse.json();
                const currentStatus = healthData.stravaSyncEnabled;
                
                // æ¸¬è©¦åˆ‡æ›ç‹€æ…‹
                const toggleResponse = await fetch('/api/strava/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        action: 'toggle',
                        enabled: !currentStatus
                    })
                });
                
                const toggleData = await toggleResponse.json();
                
                // æ¢å¾©åŸç‹€æ…‹
                await fetch('/api/strava/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        action: 'toggle',
                        enabled: currentStatus
                    })
                });
                
                const resultText = `âš™ï¸ ç‹€æ…‹ç®¡ç† API æ¸¬è©¦çµæœ:

åŸå§‹ç‹€æ…‹: ${currentStatus ? 'å•Ÿç”¨' : 'ç¦ç”¨'}
åˆ‡æ›æ“ä½œ: ${toggleResponse.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
æ–°ç‹€æ…‹: ${toggleData.stravaSyncEnabled ? 'å•Ÿç”¨' : 'ç¦ç”¨'}
ç‹€æ…‹å·²æ¢å¾©: âœ… æ˜¯`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ ç‹€æ…‹ç®¡ç†æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testSmartMerge() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦æ™ºæ…§åˆä½µ...';
            
            try {
                const userId = localStorage.getItem('currentUser');
                const token = localStorage.getItem('token');
                
                // æ¨¡æ“¬æœ¬åœ°å’Œé›²ç«¯æ•¸æ“š
                const localData = {
                    calendarEvents: {
                        '2024-01-15': [
                            { type: 'è·‘æ­¥', distance: 5, source: 'Strava', strava_id: '123' }
                        ]
                    }
                };
                
                const cloudData = {
                    calendarEvents: {
                        '2024-01-15': [
                            { type: 'æ¸¸æ³³', distance: 2, source: 'manual' }
                        ],
                        '2024-01-16': [
                            { type: 'é¨è»Š', distance: 20, source: 'manual' }
                        ]
                    }
                };
                
                // æ¸¬è©¦æ™ºæ…§åˆä½µ
                const response = await fetch(`/api/user-data/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        data: localData,
                        mergeStrategy: 'smart'
                    })
                });
                
                const resultText = `ğŸ§  æ™ºæ…§åˆä½µæ¸¬è©¦çµæœ:

ç‹€æ…‹ç¢¼: ${response.status}
åˆä½µç­–ç•¥: smart
æœ¬åœ°æ•¸æ“š: ${JSON.stringify(localData, null, 2)}
é›²ç«¯æ•¸æ“š: ${JSON.stringify(cloudData, null, 2)}
åˆä½µæˆåŠŸ: ${response.ok ? 'âœ… æ˜¯' : 'âŒ å¦'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = response.ok ? 'result success' : 'result error';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ™ºæ…§åˆä½µæ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        // ===== æ€§èƒ½æ¸¬è©¦ =====
        function testPerformance() {
            const resultDiv = document.getElementById('performanceResult');
            resultDiv.innerHTML = 'æ­£åœ¨é€²è¡Œæ€§èƒ½æ¸¬è©¦...';
            
            try {
                const startTime = performance.now();
                
                // æ¸¬è©¦çµ±ä¸€ç®¡ç†å™¨çš„æ€§èƒ½
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                // æ¸¬è©¦æ–¹æ³•èª¿ç”¨æ€§èƒ½
                const state = unified.getState();
                const stats = unified.getStats();
                
                const endTime = performance.now();
                const executionTime = endTime - startTime;
                
                // æ¸¬è©¦å…§å­˜ä½¿ç”¨
                const memoryInfo = performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                } : null;
                
                const resultText = `âš¡ æ€§èƒ½æ¸¬è©¦çµæœ:

â±ï¸ åŸ·è¡Œæ™‚é–“: ${executionTime.toFixed(2)}ms
ğŸ“Š ç‹€æ…‹ç²å–: ${typeof state === 'object' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
ğŸ“ˆ çµ±è¨ˆç²å–: ${typeof stats === 'object' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}

${memoryInfo ? `ğŸ’¾ å…§å­˜ä½¿ç”¨:
- å·²ä½¿ç”¨: ${memoryInfo.used}MB
- ç¸½è¨ˆ: ${memoryInfo.total}MB
- é™åˆ¶: ${memoryInfo.limit}MB` : 'ğŸ’¾ å…§å­˜ä¿¡æ¯ä¸å¯ç”¨'}

ğŸ¯ æ€§èƒ½è©•ç´š: ${executionTime < 10 ? 'å„ªç§€' : executionTime < 50 ? 'è‰¯å¥½' : 'éœ€è¦å„ªåŒ–'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ€§èƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        function testMemoryUsage() {
            const resultDiv = document.getElementById('performanceResult');
            
            try {
                if (!performance.memory) {
                    resultDiv.innerHTML = 'âŒ å…§å­˜ä¿¡æ¯ä¸å¯ç”¨ï¼ˆéœ€è¦ Chrome ç€è¦½å™¨ï¼‰';
                    resultDiv.className = 'result warning';
                    return;
                }
                
                const memoryInfo = {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                };
                
                const usagePercent = Math.round((memoryInfo.used / memoryInfo.limit) * 100);
                
                const resultText = `ğŸ’¾ å…§å­˜ä½¿ç”¨è©³æƒ…:

ğŸ“Š ç•¶å‰ä½¿ç”¨: ${memoryInfo.used}MB
ğŸ“ˆ ç¸½è¨ˆåˆ†é…: ${memoryInfo.total}MB
ğŸš« é™åˆ¶: ${memoryInfo.limit}MB
ğŸ“Š ä½¿ç”¨ç‡: ${usagePercent}%

${usagePercent < 50 ? 'âœ… å…§å­˜ä½¿ç”¨æ­£å¸¸' : usagePercent < 80 ? 'âš ï¸ å…§å­˜ä½¿ç”¨è¼ƒé«˜' : 'âŒ å…§å­˜ä½¿ç”¨éé«˜'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = usagePercent < 80 ? 'result success' : 'result warning';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ å…§å­˜æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        function testRequestDeduplication() {
            const resultDiv = document.getElementById('performanceResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦è«‹æ±‚å»é‡...';
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                // æ¨¡æ“¬å¤šå€‹ç›¸åŒçš„è«‹æ±‚
                const startTime = performance.now();
                const promises = [];
                
                for (let i = 0; i < 5; i++) {
                    promises.push(
                        unified.makeRequest('test-request', () => 
                            Promise.resolve({ data: 'test', timestamp: Date.now() })
                        )
                    );
                }
                
                Promise.all(promises).then(results => {
                    const endTime = performance.now();
                    const executionTime = endTime - startTime;
                    
                    // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰çµæœéƒ½ç›¸åŒï¼ˆè¡¨ç¤ºå»é‡æˆåŠŸï¼‰
                    const allSame = results.every(result => 
                        JSON.stringify(result) === JSON.stringify(results[0])
                    );
                    
                    const resultText = `ğŸ”„ è«‹æ±‚å»é‡æ¸¬è©¦çµæœ:

ğŸ“Š ä¸¦ç™¼è«‹æ±‚æ•¸: 5
â±ï¸ åŸ·è¡Œæ™‚é–“: ${executionTime.toFixed(2)}ms
ğŸ¯ å»é‡æ•ˆæœ: ${allSame ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
ğŸ“ˆ å¹³å‡éŸ¿æ‡‰æ™‚é–“: ${(executionTime / 5).toFixed(2)}ms

${allSame ? 'âœ… è«‹æ±‚å»é‡æ©Ÿåˆ¶å·¥ä½œæ­£å¸¸' : 'âŒ è«‹æ±‚å»é‡æ©Ÿåˆ¶å¯èƒ½å¤±æ•ˆ'}`;
                    
                    resultDiv.innerHTML = resultText;
                    resultDiv.className = allSame ? 'result success' : 'result error';
                });
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ è«‹æ±‚å»é‡æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        // ===== æ•´åˆæ¸¬è©¦ =====
        async function runFullIntegrationTest() {
            const resultDiv = document.getElementById('integrationResult');
            resultDiv.innerHTML = 'æ­£åœ¨é€²è¡Œå®Œæ•´æ•´åˆæ¸¬è©¦...';
            
            try {
                const testResults = [];
                const startTime = performance.now();
                
                // 1. æª¢æŸ¥çµ±ä¸€ç®¡ç†å™¨
                const unified = window.stravaSyncManager;
                testResults.push({
                    test: 'çµ±ä¸€ç®¡ç†å™¨è¼‰å…¥',
                    result: unified ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'
                });
                
                // 2. æª¢æŸ¥åŸºæœ¬ç‹€æ…‹
                if (unified) {
                    const state = unified.getState();
                    testResults.push({
                        test: 'ç‹€æ…‹ç²å–',
                        result: typeof state === 'object' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'
                    });
                }
                
                // 3. æª¢æŸ¥å¾Œç«¯ API
                try {
                    const healthResponse = await fetch('/api/strava/health', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    testResults.push({
                        test: 'å¥åº·æª¢æŸ¥ API',
                        result: healthResponse.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'
                    });
                } catch (error) {
                    testResults.push({
                        test: 'å¥åº·æª¢æŸ¥ API',
                        result: 'âŒ å¤±æ•—'
                    });
                }
                
                // 4. æª¢æŸ¥ Token ç‹€æ…‹
                try {
                    const tokenResponse = await fetch('/api/strava/check-token', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    testResults.push({
                        test: 'Token æª¢æŸ¥ API',
                        result: tokenResponse.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'
                    });
                } catch (error) {
                    testResults.push({
                        test: 'Token æª¢æŸ¥ API',
                        result: 'âŒ å¤±æ•—'
                    });
                }
                
                const endTime = performance.now();
                const totalTime = endTime - startTime;
                
                const successCount = testResults.filter(t => t.result.includes('âœ…')).length;
                const totalTests = testResults.length;
                
                let resultText = `ğŸ§ª å®Œæ•´æ•´åˆæ¸¬è©¦çµæœ:

â±ï¸ ç¸½åŸ·è¡Œæ™‚é–“: ${totalTime.toFixed(2)}ms
ğŸ“Š æ¸¬è©¦é€šéç‡: ${successCount}/${totalTests} (${Math.round(successCount/totalTests*100)}%)

ğŸ“‹ è©³ç´°çµæœ:`;
                
                testResults.forEach(test => {
                    resultText += `\n${test.test}: ${test.result}`;
                });
                
                resultText += `\n\nğŸ¯ ç¸½é«”è©•ç´š: ${successCount === totalTests ? 'âœ… å„ªç§€' : successCount >= totalTests * 0.8 ? 'âš ï¸ è‰¯å¥½' : 'âŒ éœ€è¦ä¿®å¾©'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = successCount === totalTests ? 'result success' : 'result warning';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ•´åˆæ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        function testErrorHandling() {
            const resultDiv = document.getElementById('integrationResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦éŒ¯èª¤è™•ç†...';
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                let errorHandlingResults = [];
                
                // æ¸¬è©¦ç„¡æ•ˆè«‹æ±‚
                unified.makeRequest('invalid-request', () => {
                    throw new Error('æ¨¡æ“¬éŒ¯èª¤');
                }).catch(error => {
                    errorHandlingResults.push({
                        test: 'ç„¡æ•ˆè«‹æ±‚è™•ç†',
                        result: error.message === 'æ¨¡æ“¬éŒ¯èª¤' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'
                    });
                });
                
                // æ¸¬è©¦è§€å¯Ÿè€…éŒ¯èª¤è™•ç†
                const errorObserver = (event, data) => {
                    throw new Error('è§€å¯Ÿè€…éŒ¯èª¤');
                };
                
                unified.addObserver(errorObserver);
                
                // è§¸ç™¼ä¸€å€‹äº‹ä»¶ä¾†æ¸¬è©¦éŒ¯èª¤è™•ç†
                setTimeout(() => {
                    unified.removeObserver(errorObserver);
                    
                    const resultText = `ğŸ›¡ï¸ éŒ¯èª¤è™•ç†æ¸¬è©¦çµæœ:

ğŸ“Š æ¸¬è©¦é …ç›®:
- ç„¡æ•ˆè«‹æ±‚è™•ç†: ${errorHandlingResults[0]?.result || 'â³ é€²è¡Œä¸­'}
- è§€å¯Ÿè€…éŒ¯èª¤è™•ç†: âœ… æˆåŠŸï¼ˆæœªå´©æ½°ï¼‰

ğŸ¯ éŒ¯èª¤è™•ç†è©•ç´š: ${errorHandlingResults.every(r => r.result.includes('âœ…')) ? 'âœ… å„ªç§€' : 'âš ï¸ éœ€è¦æ”¹é€²'}`;
                    
                    resultDiv.innerHTML = resultText;
                    resultDiv.className = 'result success';
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ éŒ¯èª¤è™•ç†æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        function testDataConsistency() {
            const resultDiv = document.getElementById('integrationResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦æ•¸æ“šä¸€è‡´æ€§...';
            
            try {
                const unified = window.stravaSyncManager;
                if (!unified) {
                    resultDiv.innerHTML = 'âŒ çµ±ä¸€ç®¡ç†å™¨æœªè¼‰å…¥';
                    return;
                }
                
                // æ¸¬è©¦å¤šæ¬¡ç‹€æ…‹ç²å–çš„ä¸€è‡´æ€§
                const state1 = unified.getState();
                const state2 = unified.getState();
                const stats1 = unified.getStats();
                const stats2 = unified.getStats();
                
                const stateConsistent = JSON.stringify(state1) === JSON.stringify(state2);
                const statsConsistent = JSON.stringify(stats1) === JSON.stringify(stats2);
                
                const resultText = `ğŸ”„ æ•¸æ“šä¸€è‡´æ€§æ¸¬è©¦çµæœ:

ğŸ“Š ç‹€æ…‹ä¸€è‡´æ€§: ${stateConsistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}
ğŸ“ˆ çµ±è¨ˆä¸€è‡´æ€§: ${statsConsistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}

ğŸ¯ æ•¸æ“šä¸€è‡´æ€§è©•ç´š: ${stateConsistent && statsConsistent ? 'âœ… å„ªç§€' : 'âŒ éœ€è¦ä¿®å¾©'}`;
                
                resultDiv.innerHTML = resultText;
                resultDiv.className = stateConsistent && statsConsistent ? 'result success' : 'result error';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ•¸æ“šä¸€è‡´æ€§æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        // ===== é é¢åˆå§‹åŒ– =====
        window.addEventListener('load', () => {
            console.log('çµ±ä¸€ Strava æ¶æ§‹æ¸¬è©¦é é¢å·²è¼‰å…¥');
            
            // è‡ªå‹•æ›´æ–°ç³»çµ±ç‹€æ…‹
            setTimeout(updateSystemStatus, 1000);
            
            // å®šæœŸæ›´æ–°ç‹€æ…‹
            setInterval(updateSystemStatus, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
        });
    </script>
</body>
</html>
